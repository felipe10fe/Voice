<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>voice</title>
        <script src="https://brazilrp.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
        <script src="https://brazilrp.herokuapp.com/dist/getHTMLMediaElement.js"></script>
        <script src="https://brazilrp.herokuapp.com/dist/socket.io.js"></script>
    </head>
    <body>
        <div id="audios-container" style="display: none;"></div>
        <script>
        	let connection = new RTCMultiConnection();
			let mystream = null;
			let pressingpushtotalk = false;

			connection.socketURL = "https://brazilrp.herokuapp.com:443/";

			connection.socketMessageEvent = 'voice';
			connection.leaveOnPageUnload = false;

			connection.session = {
				audio: true,
				video: false
			};

			connection.mediaConstraints = {
				audio: true,
				video: false
			};

			connection.sdpConstraints.mandatory = {
				OfferToReceiveAudio: true,
				OfferToReceiveVideo: false
			};

			connection.extra = {
				username: "",
				idOfUser: ""
			}


			connection.onstreamended = function(event) {
				// Desconectou
				var playerAudio = document.getElementById("userid_" + event.extra.idOfUser);
				playerAudio.remove();
			};

			function setVolume(playerid, pVolume){
				var playerAudio = document.getElementById(playerid);
				playerAudio.volume = pVolume;
			}

			function mutePlayer(playerid, action){
				var playerAudio = document.getElementById(playerid);
				playerAudio.muted = action;
			}

			var audiosContainer = document.getElementById('audios-container');

			connection.onstream = function ( event ) {
				event.mediaElement.id = "userid_" + event.extra.idOfUser;
				audiosContainer.append(event.mediaElement);
				 event.mediaElement.muted = true;
				
				if ( event.type == "local" ) {
					mystream = event.stream;
					event.stream.mute ( "audio" );
				}
			};

			connection.onmute = function ( event ) {

			}

			connection.onunmute = function ( event ) {

			}

			function joinRoom( username, idOfUser, room ) {
				connection.openOrJoin( room );
				if ( connection.extra.username == "" ){
					connection.extra.username = username;
				}
				if ( connection.extra.idOfUser == "" ){
					connection.extra.idOfUser = idOfUser;
				}
				connection = true;
				
			}

			document.onkeydown = function ( event ) {
				if ( !pressingpushtotalk ) {
					if ( mystream != null && event.keyCode == 0x14 ) { // 0x4E
						pressingpushtotalk = true;
						mystream.unmute( "audio" );
						mp.trigger("falandoT");
					}
				}
			};

			document.onkeyup = function ( event ) {
				if ( pressingpushtotalk ) {
					if ( mystream != null && event.keyCode == 0x14 ) {  
						pressingpushtotalk = false;
						mystream.mute( "audio" );
						mp.trigger("falandoF");
					}
				}
			};
		</script>
    </body>
</html>
