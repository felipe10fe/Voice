<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>voice</title>
        <script src="https://brazilrp.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
        <script src="https://brazilrp.herokuapp.com/dist/getHTMLMediaElement.js"></script>
        <script src="https://brazilrp.herokuapp.com/dist/socket.io.js"></script>
        <style>
            #talking_info {
                position: absolute;
                top: 48%;
                left: 1%;
                font-size: 1.0em;
                overflow: hidden;
                max-height: 52%;
                color: #fff;
                text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;
            }

            .talking_name {
                position: relative;
            }
        </style>
    </head>
    <body>
        <div id="audios_container"></div>
        <div id="talking_info"></div>
        <button id="btn-open-room">Open Room</button>
        <button id="btn-join-room">Join Room</button><hr>
        <script>
            let talkinginfo = document.getElementById( "talking_info" );
        	let connection = new RTCMultiConnection();
            let mystream = null;
            let pressingpushtotalk = false;
            let alreadyjoined = false;

			connection.socketURL = "https://brazilrp.herokuapp.com:443/";

			connection.socketMessageEvent = 'voice';
			connection.leaveOnPageUnload = false;

			connection.session = {
			    audio: true,
			    video: false
			};

			connection.mediaConstraints = {
			    audio: true,
			    video: false
			};

			connection.sdpConstraints.mandatory = {
			    OfferToReceiveAudio: true,
			    OfferToReceiveVideo: false
            };

            connection.extra = {
                username: ""
            }

			connection.audiosContainer = document.getElementById( "audios_container" );

			connection.onstream = function ( event ) {
                event.mediaElement.id = event.extra.username;

			    if ( event.type == "local" ) {
			    	mystream = event.stream;
			    	event.stream.mute ( "audio" );
			    }
			};

            connection.onmute = function ( event ) {
                removeTalking( event.mediaElement.id );
            }

            connection.onunmute = function ( event ) {
                addTalking( event.mediaElement.id );
            }

            function joinRoom( room, username ) {
                clearTalking();
                if ( connection.extra.username == "" )
                    connection.extra.username = username;
                if ( alreadyjoined )
                	connection.leave();
                connection = true;
				connection.openOrJoin ( room );
            }

            function addTalking( name ) {
                let div = document.createElement( "div" );
                div.innerHTML = name;
                div.className = "talking_name";
                div.id = name;
                talkinginfo.appendChild( div );
            }

            function removeTalking( name ) {
                let div = document.getElementById( name );
                //div.outerHTML = "";
                delete div;
            }

            function clearTalking() {
                while ( talkinginfo.firstChild ) {
                    talkinginfo.removeChild( talkinginfo.firstChild );
                }
            }


            document.onkeydown = function ( event ) {
                if ( !pressingpushtotalk ) {
                    if ( mystream != null && event.keyCode == 0x4E ) { // N
                        pressingpushtotalk = true;
                        mystream.unmute( "audio" );
                    }
                }
			};

            document.onkeyup = function ( event ) {
                if ( pressingpushtotalk ) {
                    if ( mystream != null && event.keyCode == 0x4E ) {  // N
                        pressingpushtotalk = false;
                        mystream.mute( "audio" );
                    }
                }
            };
            var predefinedRoomId = 'roleplay';

            document.getElementById('btn-open-room').onclick = function() {
                this.disabled = true;
                connection.open( predefinedRoomId );
            };

            document.getElementById('btn-join-room').onclick = function() {
                this.disabled = true;
                connection.join( predefinedRoomId );
            };

		</script>
	    <script>
// ......................................................
// .......................UI Code........................
// ......................................................
document.getElementById('open-room').onclick = function() {
    disableInputButtons();
    connection.open(document.getElementById('room-id').value, function() {
        showRoomURL(connection.sessionid);
    });
};
document.getElementById('join-room').onclick = function() {
    disableInputButtons();
    connection.join(document.getElementById('room-id').value);
};
document.getElementById('open-or-join-room').onclick = function() {
    disableInputButtons();
    connection.openOrJoin(document.getElementById('room-id').value, function(isRoomExist, roomid) {
        if (!isRoomExist) {
            showRoomURL(roomid);
        }
    });
};
// ......................................................
// ..................RTCMultiConnection Code.............
// ......................................................
var connection = new RTCMultiConnection();
// by default, socket.io server is assumed to be deployed on your own URL
connection.socketURL = '/';
// comment-out below line if you do not have your own socket.io server
// connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
connection.socketMessageEvent = 'audio-conference-demo';
connection.session = {
    audio: true,
    video: false
};
connection.mediaConstraints = {
    audio: true,
    video: false
};
connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: false
};
connection.audiosContainer = document.getElementById('audios-container');
connection.onstream = function(event) {
    var width = parseInt(connection.audiosContainer.clientWidth / 2) - 20;
    var mediaElement = getHTMLMediaElement(event.mediaElement, {
        title: event.userid,
        buttons: ['full-screen'],
        width: width,
        showOnMouseEnter: false
    });
    connection.audiosContainer.appendChild(mediaElement);
    setTimeout(function() {
        mediaElement.media.play();
    }, 5000);
    mediaElement.id = event.streamid;
};
connection.onstreamended = function(event) {
    var mediaElement = document.getElementById(event.streamid);
    if (mediaElement) {
        mediaElement.parentNode.removeChild(mediaElement);
    }
};
function disableInputButtons() {
    document.getElementById('open-or-join-room').disabled = true;
    document.getElementById('open-room').disabled = true;
    document.getElementById('join-room').disabled = true;
    document.getElementById('room-id').disabled = true;
}
// ......................................................
// ......................Handling Room-ID................
// ......................................................
function showRoomURL(roomid) {
    var roomHashURL = '#' + roomid;
    var roomQueryStringURL = '?roomid=' + roomid;
    var html = '<h2>Unique URL for your room:</h2><br>';
    html += 'Hash URL: <a href="' + roomHashURL + '" target="_blank">' + roomHashURL + '</a>';
    html += '<br>';
    html += 'QueryString URL: <a href="' + roomQueryStringURL + '" target="_blank">' + roomQueryStringURL + '</a>';
    var roomURLsDiv = document.getElementById('room-urls');
    roomURLsDiv.innerHTML = html;
    roomURLsDiv.style.display = 'block';
}
(function() {
    var params = {},
        r = /([^&=]+)=?([^&]*)/g;
    function d(s) {
        return decodeURIComponent(s.replace(/\+/g, ' '));
    }
    var match, search = window.location.search;
    while (match = r.exec(search.substring(1)))
        params[d(match[1])] = d(match[2]);
    window.params = params;
})();
var roomid = '';
if (localStorage.getItem(connection.socketMessageEvent)) {
    roomid = localStorage.getItem(connection.socketMessageEvent);
} else {
    roomid = connection.token();
}
document.getElementById('room-id').value = roomid;
document.getElementById('room-id').onkeyup = function() {
    localStorage.setItem(connection.socketMessageEvent, this.value);
};
var hashString = location.hash.replace('#', '');
if (hashString.length && hashString.indexOf('comment-') == 0) {
    hashString = '';
}
var roomid = params.roomid;
if (!roomid && hashString.length) {
    roomid = hashString;
}
if (roomid && roomid.length) {
    document.getElementById('room-id').value = roomid;
    localStorage.setItem(connection.socketMessageEvent, roomid);
    // auto-join-room
    (function reCheckRoomPresence() {
        connection.checkPresence(roomid, function(isRoomExist) {
            if (isRoomExist) {
                connection.join(roomid);
                return;
            }
            setTimeout(reCheckRoomPresence, 5000);
        });
    })();
    disableInputButtons();
}
</script>
    </body>
</html>
